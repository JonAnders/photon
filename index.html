<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Photon</title>
    <style>
      body {
        margin: 0px;
        font-family: arial;
        background-color: #222;
      }
      #resize-dialog #width {
        width: 50px;
      }
      #resize-dialog #height {
        width: 50px;
      }
      #resize-dialog span {
        padding-left: 7px;
        padding-right: 10px;
      }
      .form-group {
        float: left;
      }
      .form-group label {
        font-size: 10px;
        color: #aaa;
      }
    </style>
  </head>
  <body>
    <canvas id="image-canvas"></canvas>

    <dialog id="resize-dialog">
      <form method="dialog">
        <div class="form-group">
          <label for="resize-width">Width</label><br>
          <input id="resize-width" type="number" min="1" max="999999" required />
          <span>x</span>
        </div>
        <div class="form-group">
          <label for="resize-height">Height</label><br>
          <input id="resize-height" type="number" min="1" max="999999" required />
          <button id="resize-submit" type="submit">Resize</button>
        </div>
      </form>
    </dialog>

    <script>
      var remote = require('remote');
      var Menu = remote.require('menu');
      var dialog = remote.require('dialog');
      var fs = require('fs');

      var canvas = document.getElementById('image-canvas');
      canvas.width = 0;
      canvas.height = 0;
      var context = canvas.getContext('2d');
      var image = new Image();
      image.onload = function() {
        canvas.width = image.width;
        canvas.height = image.height;
        context.drawImage(image, 0, 0);
      };
      var appMenu = Menu.getApplicationMenu();
      var menuTemplate = [
        {
          label: 'File',
          submenu: [
            {
              label: 'Open',
              click: function() {
                var imagePaths = dialog.showOpenDialog({ properties: ['openFile']});
                if (imagePaths)
                  image.src = imagePaths[0];
              }
            },
            {
              label: 'Save'
            },
            {
              label: 'Save As',
              click: function() {
                var imagePath = dialog.showSaveDialog({
                  filters:
                    [
                      { name: 'jpg', extensions: ['jpg'] }
                    ]
                  });
                if (!imagePath)
                  return;

                var dataUrl = canvas.toDataURL('image/jpeg');
                var byteString = atob(dataUrl.split(',')[1]);
                var buffer = new Buffer(byteString.length);
                for (var i = 0; i < byteString.length; i++) {
                  buffer.writeUInt8(byteString.charCodeAt(i), i);
                }
                fs.writeFile(imagePath, buffer, function(err){
                  if (err)
                    alert(err);
                })
              }
            }
          ]
        },
        {
          label: 'Image',
          submenu: [
            {
              label: 'Resize canvas',
              click: function() {
                var dialog = document.getElementById('resize-dialog');
                var widthInput = document.getElementById('resize-width');
                var heightInput = document.getElementById('resize-height');
                var submit = document.getElementById('resize-submit');

                widthInput.value = canvas.width;
                heightInput.value = canvas.height;

                submit.addEventListener('click', function() {
                  var imageData = context.getImageData(0, 0, canvas.width - 1, canvas.height - 1);
                  canvas.width = widthInput.value;
                  canvas.height = heightInput.value;
                  context.putImageData(imageData, 0, 0);
                });

                dialog.showModal();
              }
            }
          ]
        }
      ];
      var menu = Menu.buildFromTemplate(menuTemplate);
      appMenu.insert(1, menu.items[0]);
      appMenu.insert(3, menu.items[1]);
      Menu.setApplicationMenu(appMenu);
    </script>
  </body>
</html>
