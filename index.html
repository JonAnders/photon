<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Photon</title>
    <style>
      body {
        margin: 0px;
      }
    </style>
  </head>
  <body>
    <canvas id="image-canvas"></canvas>

    <script>
      var remote = require('remote');
      var Menu = remote.require('menu');
      var dialog = remote.require('dialog');
      var fs = require('fs');

      var canvas = document.getElementById('image-canvas');
      var context = canvas.getContext('2d');
      var image = new Image();
      image.onload = function() {
        canvas.width = image.width;
        canvas.height = image.height;
        context.drawImage(image, 0, 0);
      };
      var appMenu = Menu.getApplicationMenu();
      var menuTemplate = [
        {
          label: 'File',
          submenu: [
            {
              label: 'Open',
              click: function() {
                var imagePaths = dialog.showOpenDialog({ properties: ['openFile']});
                if (imagePaths)
                  image.src = imagePaths[0];
              }
            },
            {
              label: 'Save'
            },
            {
              label: 'Save As',
              click: function() {
                var imagePath = dialog.showSaveDialog({
                  filters:
                    [
                      { name: 'jpg', extensions: ['jpg'] }
                    ]
                  });
                if (!imagePath)
                  return;

                var dataUrl = canvas.toDataURL('image/jpeg');
                var byteString = atob(dataUrl.split(',')[1]);
                var buffer = new Buffer(byteString.length);
                for (var i = 0; i < byteString.length; i++) {
                  buffer.writeUInt8(byteString.charCodeAt(i), i);
                }
                fs.writeFile(imagePath, buffer, function(err){
                  if (err)
                    alert(err);
                })
              }
            }
          ]
        },
        {
          label: 'Image',
          submenu: [
            {
              label: 'Resize canvas'
            }
          ]
        }
      ];
      var menu = Menu.buildFromTemplate(menuTemplate);
      appMenu.insert(1, menu.items[0]);
      appMenu.insert(3, menu.items[1]);
      Menu.setApplicationMenu(appMenu);
    </script>
  </body>
</html>
